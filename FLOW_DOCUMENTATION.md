# GRNDS Authentication and Player Linking Flow

## Overview
After migration 008, `players.id` is directly the Supabase auth UID. This simplifies the data model by removing the intermediate `users` table.

## Current Flow

### 1. Discord Bot Flow (Player Creation)
When a user interacts with the Discord bot:

**Step 1: `/riot link`**
- User runs `/riot link name:<name> tag:<tag> region:<region>` in Discord
- Bot calls `playerService.getOrCreatePlayer(discordUserId, username)`
- `DatabaseService.getOrCreatePlayer()` creates a player record with:
  - `discord_user_id` = Discord snowflake ID
  - `discord_username` = Discord username
  - `id` = **Generated UUID** (auto-generated by database)
  - `riot_name`, `riot_tag`, `riot_puuid`, `riot_region` = Set from command
  - Default rank/MMR values

**Step 2: `/verify`**
- User runs `/verify` in Discord
- Bot verifies the Riot account exists
- Player gets initial rank placement
- All subsequent Discord commands use `discord_user_id` to find the player

### 2. Web App Sign-In Flow (Auth Linking)
When a user signs in via Discord OAuth on the web app:

**Step 1: OAuth Callback (`/auth/callback`)**
1. User clicks "Sign In with Discord" on `hub.grnds.xyz`
2. Supabase handles Discord OAuth
3. Callback route extracts:
   - `auth.uid()` = Supabase auth UUID (from `user.id`)
   - `discord_user_id` = Discord snowflake ID (from OAuth metadata)

**Step 2: Player Linking**
The callback should:
1. Find player by `discord_user_id`
2. If player exists:
   - **Update all foreign keys** pointing to the old `id` to point to `auth.uid()`
   - **Update `players.id`** = `auth.uid()`
3. If player doesn't exist:
   - Show message: "Link your Discord account by running `/verify` in Discord first"

**Important:** We cannot directly UPDATE a primary key with foreign key dependencies. We need to:
- Update all foreign key references first
- Then update the primary key
- Or use a more sophisticated migration approach

### 3. Data Access Flow

**Web App Pages:**
- Dashboard: Query `players WHERE id = auth.uid()`
- Profile: Query `players WHERE id = <profile_id>` or `WHERE discord_user_id = <profile_id>`
- Leaderboard: Query `players ORDER BY current_mmr DESC`

**Discord Bot:**
- All queries use `discord_user_id` (unchanged)
- Bot doesn't need to know about auth UIDs

## Current Issue

The callback route is trying to `UPDATE players SET id = auth.uid()` but this will fail because:
1. `id` is a primary key
2. There are foreign keys pointing to it
3. PostgreSQL doesn't allow direct primary key updates with foreign key dependencies

## Solution Options

### Option A: Use a Database Function/Trigger (Recommended)
Create a PostgreSQL function that handles the id update atomically:
- Accepts old_id and new_id
- Updates all foreign keys in a transaction
- Updates the primary key
- Returns success/failure

### Option B: Handle in Application Code
- Create a migration-like function that updates all foreign keys
- Then update the primary key
- Must be done in a transaction

### Option C: Accept Temporary UUIDs
- Players created in Discord get UUID id
- When they sign in, we update foreign keys and then the id
- This is what we need to implement

## Recommended Implementation

For now, the callback should:
1. Find player by `discord_user_id`
2. If found AND `player.id != auth.uid()`:
   - Call a database function to atomically update all foreign keys and the id
3. If found AND `player.id == auth.uid()`:
   - Already linked, nothing to do
4. If not found:
   - Show "Run /verify in Discord first" message
